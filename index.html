<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Scheda Trasporto - Generatore PDF</title>
  <style>
    body {
      font-family: 'Segoe UI', Roboto, Arial, sans-serif;
      margin: 0;
      padding: 16px;
      background: #f0f2f5;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: #fff;
      padding: 24px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    h1 {
      text-align: center;
      margin-bottom: 24px;
      font-size: 24px;
      color: #333;
    }
    form {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
    label {
      display: block;
      font-size: 14px;
      margin-bottom: 4px;
      font-weight: 500;
    }
    input, select, textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      box-sizing: border-box;
    }
    textarea { min-height: 60px; }
    .full { grid-column: 1 / 3; }
    .section-title {
      grid-column: 1 / 3;
      font-size: 18px;
      margin-top: 16px;
      margin-bottom: 8px;
      color: #555;
      border-bottom: 1px solid #ccc;
      padding-bottom: 4px;
    }
    .buttons {
      grid-column: 1 / 3;
      display: flex;
      gap: 12px;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    button {
      padding: 10px 16px;
      font-size: 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: #4f46e5;
      color: #fff;
      transition: 0.2s;
    }
    button:hover { background: #3730a3; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 13px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
    }
    th {
      background: #f3f4f6;
      text-align: left;
    }
    .small-img { height: 40px; }
    .sign-box {
      border: 1px dashed #aaa;
      padding: 6px;
      border-radius: 6px;
    }
    .signature-control { display: flex; gap: 6px; align-items: center; margin-top: 4px; font-size: 12px; }
    @media(max-width:760px) {
      form { grid-template-columns: 1fr; }
      .full { grid-column: auto; }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Scheda Trasporto</h1>

  <form id="mainForm" onsubmit="event.preventDefault(); saveEntry();">
    <!-- Dati principali -->
    <div><label>Missione numero<input id="missione" required></label></div>
    <div><label>Data<input type="date" id="data" required></label></div>
    <div><label>Nome e Cognome<input id="nome"></label></div>
    <div><label>Età<input type="number" id="eta" min="0"></label></div>
    <div><label>Corporatura<input type="number" id="corporatura" min="0"></label></div>
    <div class="full"><label>Patologia<textarea id="patologia"></textarea></label></div>
    <div class="full"><label>Motivo trasporto<textarea id="motivo"></textarea></label></div>
    <div><label>Prelevare da<input id="prelevare"></label></div>
    <div><label>Portare a<input id="portare"></label></div>
    <div><label>PDC<input id="pdc"></label></div>
    <div><label>Telefono PDC<input id="tel" type="tel"></label></div>

    <div class="section-title">TEAM</div>
    <div><label>Autista Soccorritore<input id="autista"></label></div>
    <div><label>1° Soccorritore<input id="socc1"></label></div>
    <div><label>2° Soccorritore<input id="socc2"></label></div>
    <div><label>3° Soccorritore<input id="socc3"></label></div>
    <div><label>Tirocinante<input id="tiro"></label></div>

    <div class="section-title">INFO</div>
    <div><label>Arrivo in sede<input type="time" id="arrivoSede"></label></div>
    <div><label>Arrivo dal paziente<input type="time" id="arrivoPaz"></label></div>
    <div><label>Mezzo assegnato<input id="mezzo"></label></div>
    <div><label>Prezzo<input type="number" step="0.01" id="prezzo"></label></div>
    <div class="full"><label>Presidi necessari<textarea id="presidi"></textarea></label></div>
    <div class="full"><label>Note<textarea id="note"></textarea></label></div>

    <div class="full" style="display:flex;gap:16px;flex-wrap:wrap">
      <div style="flex:1">
        <label>Firma operatore</label>
        <div class="sign-box"><canvas id="sigOp" width="400" height="120"></canvas>
          <div class="signature-control"><button type="button" onclick="clearSig('op')">Pulisci</button></div>
        </div>
      </div>
      <div style="flex:1">
        <label>Firma referente</label>
        <div class="sign-box"><canvas id="sigRef" width="400" height="120"></canvas>
          <div class="signature-control"><button type="button" onclick="clearSig('ref')">Pulisci</button></div>
        </div>
      </div>
    </div>

    <div class="buttons">
      <button type="submit">Salva scheda</button>
      <button type="button" onclick="resetForm()">Azzera form</button>
      <button type="button" onclick="exportPDF()">Esporta tutte le schede PDF</button>
      <button type="button" onclick="exportAllAsJSON()">Esporta JSON</button>
    </div>
  </form>

  <div id="pdfArea">
    <h2>Elenco schede</h2>
    <table id="dataTable">
      <thead>
        <tr>
          <th>Missione</th><th>Data</th><th>Nome</th><th>Età</th>
          <th>Prelevare/Portare</th><th>Mezzo</th><th>Prezzo</th>
          <th>Firma Op</th><th>Firma Ref</th><th>Azioni</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- Librerie -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

<script>
const sigOp = new SignaturePad(document.getElementById('sigOp'), {backgroundColor:'rgba(255,255,255,0)'});
const sigRef = new SignaturePad(document.getElementById('sigRef'), {backgroundColor:'rgba(255,255,255,0)'});

function clearSig(who){ if(who==='op') sigOp.clear(); else sigRef.clear(); }

const STORAGE_KEY = 'schede_trasporto_v2';
let entries = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
let editingId = null;

function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,6); }

function getFormData(){
  return {
    id: editingId || uid(),
    missione: document.getElementById('missione').value,
    data: document.getElementById('data').value,
    nome: document.getElementById('nome').value,
    eta: document.getElementById('eta').value,
    corporatura: document.getElementById('corporatura').value,
    patologia: document.getElementById('patologia').value,
    motivo: document.getElementById('motivo').value,
    prelevare: document.getElementById('prelevare').value,
    portare: document.getElementById('portare').value,
    pdc: document.getElementById('pdc').value,
    tel: document.getElementById('tel').value,
    autista: document.getElementById('autista').value,
    socc1: document.getElementById('socc1').value,
    socc2: document.getElementById('socc2').value,
    socc3: document.getElementById('socc3').value,
    tiro: document.getElementById('tiro').value,
    arrivoSede: document.getElementById('arrivoSede').value,
    arrivoPaz: document.getElementById('arrivoPaz').value,
    mezzo: document.getElementById('mezzo').value,
    prezzo: document.getElementById('prezzo').value,
    presidi: document.getElementById('presidi').value,
    note: document.getElementById('note').value,
    firmaOp: sigOp.isEmpty()?null:sigOp.toDataURL(),
    firmaRef: sigRef.isEmpty()?null:sigRef.toDataURL(),
  };
}

function saveEntry(){
  const data = getFormData();
  if(!data.missione){ alert('Compila Missione numero'); return; }
  if(editingId){
    const idx = entries.findIndex(e=>e.id===editingId);
    if(idx!==-1) entries[idx]=data;
    editingId=null;
  } else entries.unshift(data);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
  renderTable();
  resetForm();
}

function renderTable(){
  const tbody = document.querySelector('#dataTable tbody');
  tbody.innerHTML='';
  for(const e of entries){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(e.missione)}</td>
      <td>${escapeHtml(e.data)}</td>
      <td>${escapeHtml(e.nome)}</td>
      <td>${escapeHtml(e.eta)}</td>
      <td>${escapeHtml(e.prelevare)} / ${escapeHtml(e.portare)}</td>
      <td>${escapeHtml(e.mezzo)}</td>
      <td>${escapeHtml(e.prezzo)}</td>
      <td>${e.firmaOp?'<img class="small-img" src="'+e.firmaOp+'">':''}</td>
      <td>${e.firmaRef?'<img class="small-img" src="'+e.firmaRef+'">':''}</td>
      <td>
        <button onclick="editEntry('${e.id}')">Modifica</button>
        <button onclick="deleteEntry('${e.id}')">Elimina</button>
        <button onclick="exportSinglePDF('${e.id}')">PDF</button>
      </td>`;
    tbody.appendChild(tr);
  }
}

function editEntry(id){
  const e = entries.find(x=>x.id===id);
  if(!e) return;
  editingId = id;
  Object.keys(e).forEach(k=>{
    if(document.getElementById(k)) document.getElementById(k).value = e[k];
  });
  if(e.firmaOp) { sigOp.clear(); sigOp.fromDataURL(e.firmaOp); } else sigOp.clear();
  if(e.firmaRef) { sigRef.clear(); sigRef.fromDataURL(e.firmaRef); } else sigRef.clear();
  window.scrollTo({top:0, behavior:'smooth'});
}

function deleteEntry(id){
  if(!confirm('Eliminare questa scheda?')) return;
  entries = entries.filter(x=>x.id!==id);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
  renderTable();
}

function resetForm(){
  editingId=null;
  document.getElementById('mainForm').reset();
  sigOp.clear(); sigRef.clear();
}

// Safe helper
function escapeHtml(str){ if(!str) return ''; return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// EXPORT PDF di tutte le schede
async function exportPDF(){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p','mm','a4');
  let y = 10;

  for(const e of entries){
    const html = `
      <div style="font-family:Arial;font-size:12px;margin-bottom:6px;">
        <b>Missione:</b> ${escapeHtml(e.missione)} | <b>Data:</b> ${escapeHtml(e.data)}<br>
        <b>Nome:</b> ${escapeHtml(e.nome)} | <b>Età:</b> ${escapeHtml(e.eta)} | <b>Corporatura:</b> ${escapeHtml(e.corporatura)}<br>
        <b>Patologia:</b> ${escapeHtml(e.patologia)}<br>
        <b>Motivo trasporto:</b> ${escapeHtml(e.motivo)}<br>
        <b>Prelevare/Portare:</b> ${escapeHtml(e.prelevare)} → ${escapeHtml(e.portare)}<br>
        <b>PDC:</b> ${escapeHtml(e.pdc)} | <b>Tel:</b> ${escapeHtml(e.tel)}<br>
        <b>TEAM:</b> ${escapeHtml(e.autista)}, ${escapeHtml(e.socc1)}, ${escapeHtml(e.socc2)}, ${escapeHtml(e.socc3)}, ${escapeHtml(e.tiro)}<br>
        <b>INFO:</b> Arrivo sede: ${escapeHtml(e.arrivoSede)}, Arrivo paziente: ${escapeHtml(e.arrivoPaz)}, Mezzo: ${escapeHtml(e.mezzo)}, Prezzo: ${escapeHtml(e.prezzo)}<br>
        <b>Presidi:</b> ${escapeHtml(e.presidi)}<br>
        <b>Note:</b> ${escapeHtml(e.note)}
      </div>
    `;
    const div = document.createElement('div');
    div.innerHTML = html;
    document.body.appendChild(div);
    const canvas = await html2canvas(div,{scale:2});
    const imgData = canvas.toDataURL('image/png');
    const pdfWidth = pdf.internal.pageSize.getWidth() - 20;
    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
    if(y + pdfHeight > pdf.internal.pageSize.getHeight()){ pdf.addPage(); y=10; }
    pdf.addImage(imgData,'PNG',10,y,pdfWidth,pdfHeight);
    y+=pdfHeight+5;
    document.body.removeChild(div);
  }

  pdf.save('schede_trasporto.pdf');
}

// EXPORT PDF singola scheda
async function exportSinglePDF(id){
  const e = entries.find(x=>x.id===id);
  if(!e) return;

  const html = `
    <div style="font-family:Arial;font-size:12px;">
      <h2>Scheda Missione ${escapeHtml(e.missione)} - ${escapeHtml(e.data)}</h2>
      <table style="width:100%;border-collapse:collapse" border="1">
        <tr><td><b>Nome</b></td><td>${escapeHtml(e.nome)}</td></tr>
        <tr><td><b>Età</b></td><td>${escapeHtml(e.eta)}</td></tr>
        <tr><td><b>Corporatura</b></td><td>${escapeHtml(e.corporatura)}</td></tr>
        <tr><td><b>Patologia</b></td><td>${escapeHtml(e.patologia)}</td></tr>
        <tr><td><b>Motivo trasporto</b></td><td>${escapeHtml(e.motivo)}</td></tr>
        <tr><td><b>Prelevare / Portare</b></td><td>${escapeHtml(e.prelevare)} → ${escapeHtml(e.portare)}</td></tr>
        <tr><td><b>PDC</b></td><td>${escapeHtml(e.pdc)}</td></tr>
        <tr><td><b>Tel PDC</b></td><td>${escapeHtml(e.tel)}</td></tr>
        <tr><td><b>TEAM</b></td><td>${escapeHtml(e.autista)}, ${escapeHtml(e.socc1)}, ${escapeHtml(e.socc2)}, ${escapeHtml(e.socc3)}, ${escapeHtml(e.tiro)}</td></tr>
        <tr><td><b>INFO</b></td><td>Arrivo sede: ${escapeHtml(e.arrivoSede)}, Arrivo paziente: ${escapeHtml(e.arrivoPaz)}, Mezzo: ${escapeHtml(e.mezzo)}, Prezzo: ${escapeHtml(e.prezzo)}</td></tr>
        <tr><td><b>Presidi</b></td><td>${escapeHtml(e.presidi)}</td></tr>
        <tr><td><b>Note</b></td><td>${escapeHtml(e.note)}</td></tr>
      </table>
      <div style="margin-top:8px">
        ${e.firmaOp?'<div><b>Firma operatore</b><br><img src="'+e.firmaOp+'" style="max-height:120px"></div>':''}
        ${e.firmaRef?'<div><b>Firma referente</b><br><img src="'+e.firmaRef+'" style="max-height:120px"></div>':''}
      </div>
    </div>
  `;

  const div = document.createElement('div');
  div.innerHTML = html;
  document.body.appendChild(div);
  const canvas = await html2canvas(div,{scale:2});
  const imgData = canvas.toDataURL('image/png');
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p','mm','a4');
  const pdfWidth = pdf.internal.pageSize.getWidth() - 20;
  const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
  pdf.addImage(imgData,'PNG',10,10,pdfWidth,pdfHeight);
  pdf.save('scheda_'+e.missione+'_'+(e.data||'')+'.pdf');
  document.body.removeChild(div);
}

// EXPORT JSON
function exportAllAsJSON(){
  const dataStr = JSON.stringify(entries, null, 2);
  const blob = new Blob([dataStr], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'schede_trasporto.json'; a.click();
  URL.revokeObjectURL(url);
}

// INIT
renderTable();
</script>
</body>
</html>
