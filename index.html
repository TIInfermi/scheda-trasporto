<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SCHEDA PAZIENTE TI</title>
<style>
body { font-family: 'Segoe UI', Roboto, Arial, sans-serif; margin:0; padding:16px; background:#f0f2f5; }
.container { max-width: 900px; margin:0 auto; background:#fff; padding:16px; border-radius:12px; box-shadow:0 6px 16px rgba(0,0,0,0.1); }
form { display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
label { display:block; font-size:14px; margin-bottom:4px; font-weight:500; }
input, select, textarea { width:100%; padding:8px 10px; border-radius:6px; border:1px solid #ccc; font-size:14px; box-sizing:border-box; }
textarea { min-height:50px; }
.full { grid-column:1/3; }
.section-title { grid-column:1/3; font-size:16px; margin-top:16px; margin-bottom:8px; color:#555; border-bottom:1px solid #ccc; padding-bottom:4px; }
.buttons { grid-column:1/3; display:flex; gap:10px; margin-top:16px; flex-wrap:wrap; }
button { padding:8px 14px; font-size:14px; border:none; border-radius:6px; cursor:pointer; background:#4f46e5; color:#fff; transition:0.2s; }
button:hover { background:#3730a3; }
table { width:100%; border-collapse:collapse; margin-top:16px; font-size:13px; }
th, td { border:1px solid #ddd; padding:6px; text-align:left; }
th { background:#f3f4f6; }
tr:hover { background:#f1f5f9; }
.sign-box { border:1px dashed #aaa; padding:4px; border-radius:6px; }
.signature-control { display:flex; gap:6px; align-items:center; margin-top:4px; font-size:12px; }
h1 { font-size:20px; text-align:center; margin-bottom:10px; }
h2 { font-size:14px; color:#555; margin-top:12px; margin-bottom:6px; border-bottom:1px solid #ccc; padding-bottom:2px; }
@media(max-width:760px){
  form { grid-template-columns:1fr; }
  .full { grid-column:auto; }
}
</style>
</head>
<body>
<div class="container">
  <div style="display:flex; align-items:center; gap:12px; margin-bottom:10px;">
    <img src="https://via.placeholder.com/100x50.png?text=LOGO" alt="Logo" style="height:50px;">
    <h1 style="margin:0; flex:1;">Scheda Paziente TI</h1>
  </div>

  <div class="section-title">INFO PAZIENTE</div>
  <form id="mainForm" onsubmit="event.preventDefault(); saveEntry();">
    <div><label>Missione numero<input id="missione" required></label></div>
    <div><label>Data<input type="date" id="data" required></label></div>
    <div><label>Nome e Cognome<input id="nome"></label></div>
    <div><label>Età<input type="number" id="eta" min="0"></label></div>
    <div><label>Corporatura<input type="number" id="corporatura" min="0"></label></div>
    <div class="full"><label>Patologia<textarea id="patologia"></textarea></label></div>
    <div class="full"><label>Motivo trasporto<textarea id="motivo"></textarea></label></div>
    <div><label>Prelevare da<input id="prelevare"></label></div>
    <div><label>Portare a<input id="portare"></label></div>
    <div><label>PDC<input id="pdc"></label></div>
    <div><label>Telefono PDC<input id="tel" type="tel"></label></div>

    <div class="section-title">TEAM</div>
    <div><label>Autista Soccorritore<input id="autista"></label></div>
    <div><label>1° Soccorritore<input id="socc1"></label></div>
    <div><label>2° Soccorritore<input id="socc2"></label></div>
    <div><label>3° Soccorritore<input id="socc3"></label></div>
    <div><label>Tirocinante<input id="tiro"></label></div>

    <div class="section-title">INFO TRASPORTO</div>
    <div><label>Arrivo in sede<input type="time" id="arrivoSede"></label></div>
    <div><label>Arrivo dal paziente<input type="time" id="arrivoPaz"></label></div>
    <div><label>Mezzo assegnato<input id="mezzo"></label></div>
    <div><label>Prezzo<input type="number" step="0.01" id="prezzo"></label></div>
    <div class="full"><label>Presidi necessari<textarea id="presidi"></textarea></label></div>
    <div class="full"><label>Note<textarea id="note"></textarea></label></div>

    <div class="full">
      <label>Firma referente</label>
      <div class="sign-box"><canvas id="sigRef" width="300" height="100"></canvas>
        <div class="signature-control"><button type="button" onclick="clearSig('ref')">Pulisci</button></div>
      </div>
    </div>

    <div class="buttons">
      <button type="submit">Salva scheda</button>
      <button type="button" onclick="resetForm()">Azzera form</button>
      <button type="button" onclick="exportAllPDF()">Esporta PDF</button>
      <button type="button" onclick="exportAllAsJSON()">Esporta JSON</button>
    </div>
  </form>

  <div id="pdfArea">
    <h2>Elenco schede</h2>
    <table id="dataTable">
      <thead><tr><th>Missione</th><th>Data</th><th>Azioni</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<script>
const sigRef = new SignaturePad(document.getElementById('sigRef'), {backgroundColor:'rgba(255,255,255,0)'});
function clearSig(who){ if(who==='ref') sigRef.clear(); }

const STORAGE_KEY='schede_trasporto_final';
let entries = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');
let editingId=null;

function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,6); }

function getFormData(){
  return {
    id: editingId||uid(),
    missione: document.getElementById('missione').value,
    data: document.getElementById('data').value,
    nome: document.getElementById('nome').value,
    eta: document.getElementById('eta').value,
    corporatura: document.getElementById('corporatura').value,
    patologia: document.getElementById('patologia').value,
    motivo: document.getElementById('motivo').value,
    prelevare: document.getElementById('prelevare').value,
    portare: document.getElementById('portare').value,
    pdc: document.getElementById('pdc').value,
    tel: document.getElementById('tel').value,
    autista: document.getElementById('autista').value,
    socc1: document.getElementById('socc1').value,
    socc2: document.getElementById('socc2').value,
    socc3: document.getElementById('socc3').value,
    tiro: document.getElementById('tiro').value,
    arrivoSede: document.getElementById('arrivoSede').value,
    arrivoPaz: document.getElementById('arrivoPaz').value,
    mezzo: document.getElementById('mezzo').value,
    prezzo: document.getElementById('prezzo').value,
    presidi: document.getElementById('presidi').value,
    note: document.getElementById('note').value,
    firmaRef: sigRef.isEmpty()?null:sigRef.toDataURL(),
    firmaData: new Date().toISOString()
  };
}

function saveEntry(){
  const data = getFormData();
  if(!data.missione){ alert('Compila Missione'); return; }
  if(editingId){ const idx = entries.findIndex(x=>x.id===editingId); if(idx!==-1) entries[idx]=data; editingId=null; }
  else entries.unshift(data);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
  renderTable();
  resetForm();
}

function renderTable(){
  const tbody=document.querySelector('#dataTable tbody');
  tbody.innerHTML='';
  for(const e of entries){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${e.missione}</td><td>${e.data}</td>
    <td>
      <button onclick="editEntry('${e.id}')">Modifica</button>
      <button onclick="deleteEntry('${e.id}')">Elimina</button>
      <button onclick="exportSinglePDF('${e.id}')">PDF</button>
    </td>`;
    tbody.appendChild(tr);
  }
}

function editEntry(id){
  const e=entries.find(x=>x.id===id);
  if(!e) return;
  editingId=id;
  for(const key in e){ if(document.getElementById(key)) document.getElementById(key).value=e[key]; }
  if(e.firmaRef) sigRef.fromDataURL(e.firmaRef); else sigRef.clear();
  window.scrollTo({top:0,behavior:'smooth'});
}

function deleteEntry(id){ if(confirm('Eliminare scheda?')){ entries=entries.filter(x=>x.id!==id); localStorage.setItem(STORAGE_KEY,JSON.stringify(entries)); renderTable(); } }
function resetForm(){ editingId=null; document.getElementById('mainForm').reset(); sigRef.clear(); }

// PDF veloce ottimizzato
async function exportSinglePDF(id){
  const e = entries.find(x=>x.id===id); if(!e) return;
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p','mm','a4');
  let y=10;

  const img = new Image();
  img.src='https://via.placeholder.com/100x50.png?text=LOGO';
  await new Promise(res=>img.onload=res);
  pdf.addImage(img,'PNG',10,10,40,20);

  pdf.setFontSize(16); pdf.text('Scheda Paziente TI',105,20,{align:'center'}); y=35;

  pdf.setFontSize(12);
  const sections = [
    {title:'INFO PAZIENTE', fields:[
      ['Nome e Cognome',e.nome],['Età',e.eta],['Corporatura',e.corporatura],['Patologia',e.patologia],
      ['Motivo trasporto',e.motivo],['Prelevare da',e.prelevare],['Portare a',e.portare],['PDC',e.pdc],['Telefono PDC',e.tel]
    ]},
    {title:'TEAM', fields:[
      ['Autista',e.autista],['1° Soccorritore',e.socc1],['2° Soccorritore',e.socc2],['3° Soccorritore',e.socc3],['Tirocinante',e.tiro]
    ]},
    {title:'INFO TRASPORTO', fields:[
      ['Arrivo in sede',e.arrivoSede],['Arrivo dal paziente',e.arrivoPaz],['Mezzo assegnato',e.mezzo],['Prezzo',e.prezzo],
      ['Presidi necessari',e.presidi],['Note',e.note]
    ]}
  ];

  sections.forEach(sec=>{
    pdf.setFontSize(14); pdf.text(sec.title,10,y); y+=6;
    pdf.setFontSize(12);
    sec.fields.forEach(f=>{ pdf.text(`${f[0]}: ${f[1]||''}`,10,y); y+=6; });
    y+=4;
  });

  pdf.text(`Generata il: ${new Date().toLocaleString('it-IT')}`,10,y); y+=6;
  if(e.firmaRef){
    const fImg = new Image();
    fImg.src=e.firmaRef;
    await new Promise(res=>fImg.onload=res);
    pdf.addImage(fImg,'PNG',10,y,80,30);
  }

  pdf.save(`scheda_${e.missione}_${e.data||''}.pdf`);
}

function exportAllPDF(){ entries.forEach(e=>exportSinglePDF(e.id)); }
function exportAllAsJSON(){ const blob=new Blob([JSON.stringify(entries,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='schede_trasporto.json'; a.click(); URL.revokeObjectURL(url); }

renderTable();
</script>
</body>
</html>
