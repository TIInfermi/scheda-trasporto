<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Gestione Schede TI</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    label { display: block; margin-top: 8px; }
    input, select, textarea { width: 100%; padding: 6px; margin-top: 4px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    h3 { margin-top: 20px; color: #333; }
    button { margin: 4px; padding: 6px 12px; }
  </style>
</head>
<body>
  <h2>Gestione Schede Trasporto Infermi</h2>

  <form id="mainForm">
    <label>Missione <input type="text" id="missione"></label>
    <label>Data <input type="date" id="data"></label>
    <label>Nome <input type="text" id="nome"></label>
    <label>Età <input type="number" id="eta"></label>
    <label>Data di nascita <input type="date" id="dob"></label>
    <label>Corporatura <input type="text" id="corporatura"></label>
    <label>Patologia <input type="text" id="patologia"></label>
    <label>Motivo trasporto <input type="text" id="motivo"></label>

    <h3>Partenza</h3>
    <label>Città di partenza <input type="text" id="cittaPartenza"></label>
    <label>Via di partenza <input type="text" id="viaPartenza"></label>
    <label>Numero civico <input type="text" id="civicoPartenza"></label>
    <label>Ascensore/montacarichi 
      <select id="ascensorePartenza">
        <option value="">-- Seleziona --</option>
        <option>Presente</option>
        <option>Assente</option>
      </select>
    </label>

    <h3>Arrivo</h3>
    <label>Città di arrivo <input type="text" id="cittaArrivo"></label>
    <label>Via di arrivo <input type="text" id="viaArrivo"></label>
    <label>Numero civico <input type="text" id="civicoArrivo"></label>
    <label>Ascensore/montacarichi 
      <select id="ascensoreArrivo">
        <option value="">-- Seleziona --</option>
        <option>Presente</option>
        <option>Assente</option>
      </select>
    </label>

    <h3>PDC</h3>
    <label>Nome PDC <input type="text" id="pdc"></label>
    <label>Telefono PDC <input type="text" id="tel"></label>

    <h3>Team</h3>
    <label>Autista <input type="text" id="autista"></label>
    <label>Soccorritore 1 <input type="text" id="socc1"></label>
    <label>Soccorritore 2 <input type="text" id="socc2"></label>
    <label>Soccorritore 3 <input type="text" id="socc3"></label>
    <label>Tirocinante <input type="text" id="tiro"></label>

    <h3>Trasporto</h3>
    <label>Arrivo in sede <input type="text" id="arrivoSede"></label>
    <label>Arrivo dal paziente <input type="text" id="arrivoPaz"></label>
    <label>Arrivo a destinazione <input type="text" id="arrivoDest"></label>
    <label>Mezzo <input type="text" id="mezzo"></label>
    <label>Prezzo <input type="text" id="prezzo"></label>
    <label>Presidi <input type="text" id="presidi"></label>
    <label>Note <textarea id="note"></textarea></label>
    <label>Link ricevuta <input type="url" id="linkRicevuta"></label>

    <h3>Altro</h3>
    <label>Firma ref <input type="text" id="firmaRef"></label>
    <label>Stato 
      <select id="stato">
        <option>In corso</option>
        <option>Completata</option>
        <option>Annullata</option>
      </select>
    </label>

    <button type="button" onclick="saveEntry()">Salva scheda</button>
  </form>

  <h2>Elenco Schede</h2>
  <table id="dataTable">
    <thead>
      <tr><th>Missione</th><th>Data</th><th>Stato</th><th>Azioni</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <button onclick="exportPDF()">Esporta tutte in PDF</button>

<script>
  // === Firebase ===
  const firebaseConfig = { /* CONFIG FIREBASE */ };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  let entries = [], editingId = null;

  function escapeHtml(t){ return t ? t.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m])):""; }

  db.collection("schede_TI").onSnapshot(snap=>{
    entries = snap.docs.map(d=>d.data());
    renderTable();
  });

  function getFormData(){
    return {
      id: editingId || Date.now().toString(),
      missione: document.getElementById('missione').value,
      data: document.getElementById('data').value,
      nome: document.getElementById('nome').value,
      eta: document.getElementById('eta').value,
      dob: document.getElementById('dob').value,
      corporatura: document.getElementById('corporatura').value,
      patologia: document.getElementById('patologia').value,
      motivo: document.getElementById('motivo').value,
      cittaPartenza: document.getElementById('cittaPartenza').value,
      viaPartenza: document.getElementById('viaPartenza').value,
      civicoPartenza: document.getElementById('civicoPartenza').value,
      ascensorePartenza: document.getElementById('ascensorePartenza').value,
      cittaArrivo: document.getElementById('cittaArrivo').value,
      viaArrivo: document.getElementById('viaArrivo').value,
      civicoArrivo: document.getElementById('civicoArrivo').value,
      ascensoreArrivo: document.getElementById('ascensoreArrivo').value,
      pdc: document.getElementById('pdc').value,
      tel: document.getElementById('tel').value,
      autista: document.getElementById('autista').value,
      socc1: document.getElementById('socc1').value,
      socc2: document.getElementById('socc2').value,
      socc3: document.getElementById('socc3').value,
      tiro: document.getElementById('tiro').value,
      arrivoSede: document.getElementById('arrivoSede').value,
      arrivoPaz: document.getElementById('arrivoPaz').value,
      arrivoDest: document.getElementById('arrivoDest').value,
      mezzo: document.getElementById('mezzo').value,
      prezzo: document.getElementById('prezzo').value,
      presidi: document.getElementById('presidi').value,
      note: document.getElementById('note').value,
      linkRicevuta: document.getElementById('linkRicevuta').value,
      firmaRef: document.getElementById('firmaRef').value,
      stato: document.getElementById('stato').value,
      timestamp: Date.now()
    };
  }

  function setFormData(e){
    editingId=e.id;
    for (let k in e) {
      if(document.getElementById(k)) document.getElementById(k).value=e[k];
    }
  }

  function resetForm(){ editingId=null; document.getElementById('mainForm').reset(); }

  function saveEntry(){
    const entry=getFormData();
    db.collection("schede_TI").doc(entry.id).set(entry).then(()=>{
      resetForm();
    });
  }

  function renderTable(){
    const tbody=document.querySelector('#dataTable tbody');
    tbody.innerHTML='';
    entries.forEach(e=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${escapeHtml(e.missione)}</td>
        <td>${e.data ? new Date(e.data).toLocaleDateString("it-IT") : ""}</td>
        <td>${escapeHtml(e.stato)}</td>
        <td>
          <button onclick="setFormData(entries.find(x=>x.id==='${e.id}'))">Modifica</button>
          <button onclick="deleteEntry('${e.id}')">Elimina</button>
          <button onclick="exportSinglePDF('${e.id}')">PDF</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  function deleteEntry(id){
    if(confirm('Sei sicuro di voler eliminare questa scheda?')){
      db.collection("schede_TI").doc(id).delete();
    }
  }

  // === PDF ===
  async function exportSinglePDF(id){
    const e = entries.find(x => x.id === id);
    if (!e) return;

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation:'p', unit:'mm', format:'a4' });
    const pageWidth = doc.internal.pageSize.getWidth();
    let y = 20;

    // Logo
    const img = new Image();
    img.src = "https://r2.fivemanage.com/qTNmb8WLSLzz3wAA8WJPV/802edc62968aa9566f7685ac09524d39(1).png";
    await new Promise(r => { img.onload = r; });
    doc.addImage(img, 'PNG', 15, y, 30, 30);
    doc.setFontSize(18);
    doc.text("Scheda Paziente TI", pageWidth/2, y+15, { align:"center" });
    y += 40;

    function addSection(title, rows){
      doc.setFontSize(14);
      doc.setFont("helvetica","bold");
      doc.text(title, 15, y);
      y += 6;
      doc.setFontSize(11);
      doc.setFont("helvetica","normal");
      rows.forEach(([k,v])=>{
        doc.text(`${k}:`, 20, y);
        doc.text(v || "-", 70, y);
        y += 6;
        if(y > 270){ doc.addPage(); y=20; }
      });
      y += 4;
    }

    addSection("Info paziente", [
      ["Missione", e.missione],
      ["Data", e.data ? new Date(e.data).toLocaleDateString("it-IT") : ""],
      ["Nome", e.nome],
      ["Età", e.eta],
      ["Data di nascita", e.dob],
      ["Corporatura", e.corporatura],
      ["Patologia", e.patologia],
      ["Motivo", e.motivo]
    ]);

    addSection("Partenza", [
      ["Città", e.cittaPartenza],
      ["Via", e.viaPartenza],
      ["Civico", e.civicoPartenza],
      ["Ascensore", e.ascensorePartenza]
    ]);

    addSection("Arrivo", [
      ["Città", e.cittaArrivo],
      ["Via", e.viaArrivo],
      ["Civico", e.civicoArrivo],
      ["Ascensore", e.ascensoreArrivo]
    ]);

    addSection("PDC", [
      ["Nome PDC", e.pdc],
      ["Telefono PDC", e.tel]
    ]);

    addSection("Team", [
      ["Autista", e.autista],
      ["Soccorritore 1", e.socc1],
      ["Soccorritore 2", e.socc2],
      ["Soccorritore 3", e.socc3],
      ["Tirocinante", e.tiro]
    ]);

    addSection("Trasporto", [
      ["Arrivo in sede", e.arrivoSede],
      ["Arrivo dal paziente", e.arrivoPaz],
      ["Arrivo a destinazione", e.arrivoDest],
      ["Mezzo", e.mezzo],
      ["Prezzo", e.prezzo],
      ["Presidi", e.presidi],
      ["Note", e.note],
      ["Link ricevuta", e.linkRicevuta]
    ]);

    addSection("Altro", [
      ["Firma ref", e.firmaRef],
      ["Stato", e.stato]
    ]);

    doc.setFontSize(10);
    doc.setTextColor(200,0,0);
    doc.text(`Generato il: ${new Date(e.timestamp).toLocaleString("it-IT")}`, pageWidth-15, 290, {align:"right"});

    doc.save(`scheda_${e.missione}.pdf`);
  }

  async function exportPDF(){
    if(entries.length===0){ alert("Nessuna scheda da esportare"); return; }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation:'p', unit:'mm', format:'a4' });
    const pageWidth = doc.internal.pageSize.getWidth();
    let first=true;

    for(const e of entries){
      if(!first) doc.addPage();
      first=false;

      let y = 20;
      const img = new Image();
      img.src = "https://r2.fivemanage.com/qTNmb8WLSLzz3wAA8WJPV/802edc62968aa9566f7685ac09524d39(1).png";
      await new Promise(r => { img.onload = r; });
      doc.addImage(img,'PNG',15,y,30,30);
      doc.setFontSize(18);
      doc.text("Scheda Paziente TI", pageWidth/2, y+15, { align:"center" });
      y += 40;

      function addSection(title, rows){
        doc.setFontSize(14);
        doc.setFont("helvetica","bold");
        doc.text(title, 15, y);
        y += 6;
        doc.setFontSize(11);
        doc.setFont("helvetica","normal");
        rows.forEach(([k,v])=>{
          doc.text(`${k}:`, 20, y);
          doc.text(v || "-", 70, y);
          y += 6;
          if(y > 270){ doc.addPage(); y=20; }
        });
        y += 4;
      }

      addSection("Info paziente", [
        ["Missione", e.missione],
        ["Data", e.data ? new Date(e.data).toLocaleDateString("it-IT") : ""],
        ["Nome", e.nome],
        ["Età", e.eta],
        ["Data di nascita", e.dob],
        ["Corporatura", e.corporatura],
        ["Patologia", e.patologia],
        ["Motivo", e.motivo]
      ]);

      addSection("Partenza", [
        ["Città", e.cittaPartenza],
        ["Via", e.viaPartenza],
        ["Civico", e.civicoPartenza],
        ["Ascensore", e.ascensorePartenza]
      ]);

      addSection("Arrivo", [
        ["Città", e.cittaArrivo],
        ["Via", e.viaArrivo],
        ["Civico", e.civicoArrivo],
        ["Ascensore", e.ascensoreArrivo]
      ]);

      addSection("PDC", [
        ["Nome PDC", e.pdc],
        ["Telefono PDC", e.tel]
      ]);

      addSection("Team", [
        ["Autista", e.autista],
        ["Soccorritore 1", e.socc1],
        ["Soccorritore 2", e.socc2],
        ["Soccorritore 3", e.socc3],
        ["Tirocinante", e.tiro]
      ]);

      addSection("Trasporto", [
        ["Arrivo in sede", e.arrivoSede],
        ["Arrivo dal paziente", e.arrivoPaz],
        ["Arrivo a destinazione", e.arrivoDest],
        ["Mezzo", e.mezzo],
        ["Prezzo", e.prezzo],
        ["Presidi", e.presidi],
        ["Note", e.note],
        ["Link ricevuta", e.linkRicevuta]
      ]);

      addSection("Altro", [
        ["Firma ref", e.firmaRef],
        ["Stato", e.stato]
      ]);

      doc.setFontSize(10);
      doc.setTextColor(200,0,0);
      doc.text(`Generato il: ${new Date(e.timestamp).toLocaleString("it-IT")}`, pageWidth-15, 
