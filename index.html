<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Scheda TI</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { text-align: center; }
    form { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-width: 1000px; margin: auto; }
    label { display: flex; flex-direction: column; font-weight: bold; }
    input, select, textarea { padding: 5px; font-size: 14px; }
    .full { grid-column: 1 / 3; }
    .buttons { text-align: center; margin: 20px; }
    .buttons button { margin: 5px; padding: 10px 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 30px; }
    th, td { border: 1px solid #999; padding: 6px; font-size: 13px; }
    th { background: #eee; }
  </style>
</head>
<body>
  <h1>Scheda TI</h1>
  <form id="tiForm">
    <div><label>Nr Missione<input id="missione"></label></div>
    <div><label>Data<input type="date" id="data"></label></div>
    <div><label>Nome paziente<input id="nome"></label></div>
    <div><label>Età<input type="number" id="eta" min="0"></label></div>
    <div><label>Data di nascita<input type="date" id="dob"></label></div>
    <div><label>Corporatura<input type="number" id="corporatura" min="0"></label></div>
    <div><label>Patologia<input id="patologia"></label></div>
    <div><label>Motivo trasporto<input id="motivo"></label></div>
    <div><label>Prelevare da<input id="prelevare"></label></div>
    <div><label>Portare a<input id="portare"></label></div>
    <div><label>Presidio Richiedente<input id="pdc"></label></div>
    <div><label>Telefono PDC<input id="tel" type="number"></label></div>
    <div><label>Autista<input id="autista"></label></div>
    <div><label>Soccorritore 1<input id="socc1"></label></div>
    <div><label>Soccorritore 2<input id="socc2"></label></div>
    <div><label>Soccorritore 3<input id="socc3"></label></div>
    <div><label>Tirocinante<input id="tiro"></label></div>
    <div><label>Arrivo in sede<input type="time" id="arrivoSede"></label></div>
    <div><label>Arrivo dal paziente<input type="time" id="arrivoPaz"></label></div>
    <div><label>Arrivo a destinazione<input type="time" id="arrivoDest"></label></div>
    <div>
      <label>Mezzo assegnato
        <select id="mezzo">
          <option value="">-- Seleziona --</option>
          <option>ABZ 205</option>
          <option>ABZ 406</option>
          <option>ABZ 551</option>
          <option>ABZ 237</option>
          <option>ABZ 788</option>
          <option>ABZ 689</option>
          <option>DOBLO' 006</option>
          <option>PUNTO BIANCA 428</option>
          <option>PUNTO BLU 159</option>
        </select>
      </label>
    </div>
    <div><label>Prezzo<input id="prezzo" type="number" step="0.01" min="0"></label></div>
    <div class="full"><label>Presidi<input id="presidi"></label></div>
    <div class="full"><label>Note<textarea id="note"></textarea></label></div>
    <div class="full"><label>Firma referente (nome e cognome)<input id="firmaRef"></label></div>
  </form>
  <div class="buttons">
    <button type="submit" form="tiForm">Salva scheda TI</button>
    <button type="button" onclick="resetForm()">Pulisci scheda TI</button>
    <button type="button" onclick="exportPDF()">Esporta PDF</button>
  </div>
  
  <h2>Archivio schede TI</h2>
  <table id="archivio"><thead><tr>
    <th>Missione</th><th>Data</th><th>Nome</th><th>Azioni</th>
  </tr></thead><tbody></tbody></table>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const { jsPDF } = window.jspdf;
    let schede = JSON.parse(localStorage.getItem('schedeTI')||'[]');
    let editingId = null;

// Formatta automaticamente il prezzo in tempo reale
document.getElementById("prezzo").addEventListener("input", function(){
  let raw = this.value.replace(/[^\d.]/g,""); // elimina simboli
  let v = parseFloat(raw);
  if(!isNaN(v)){
    this.value = v.toFixed(2) + "€";
  } else {
    this.value = "";
  }
});

    function uid(){return '_' + Math.random().toString(36).substr(2,9);}
    function getFormData(){
      return {
        id: editingId||uid(),
        missione: missione.value,
        data: data.value,
        nome: nome.value,
        eta: eta.value,
        dob: dob.value,
        corporatura: corporatura.value,
        patologia: patologia.value,
        motivo: motivo.value,
        prelevare: prelevare.value,
        portare: portare.value,
        pdc: pdc.value,
        tel: tel.value,
        autista: autista.value,
        socc1: socc1.value,
        socc2: socc2.value,
        socc3: socc3.value,
        tiro: tiro.value,
        arrivoSede: arrivoSede.value,
        arrivoPaz: arrivoPaz.value,
        arrivoDest: arrivoDest.value,
        mezzo: mezzo.value,
        prezzo: prezzo.value,
        presidi: presidi.value,
        note: note.value,
        firmaRef: firmaRef.value,
        timestamp: new Date().toLocaleString()
      };
    }
    function setFormData(e){
      missione.value=e.missione;data.value=e.data;nome.value=e.nome;eta.value=e.eta;
      dob.value=e.dob;corporatura.value=e.corporatura;patologia.value=e.patologia;
      motivo.value=e.motivo;prelevare.value=e.prelevare;portare.value=e.portare;
      pdc.value=e.pdc;tel.value=e.tel;autista.value=e.autista;socc1.value=e.socc1;
      socc2.value=e.socc2;socc3.value=e.socc3;tiro.value=e.tiro;
      arrivoSede.value=e.arrivoSede;arrivoPaz.value=e.arrivoPaz;arrivoDest.value=e.arrivoDest;
      mezzo.value=e.mezzo;prezzo.value=e.prezzo;presidi.value=e.presidi;
      note.value=e.note;firmaRef.value=e.firmaRef;
    }
    function renderArchivio(){
      const tbody=document.querySelector('#archivio tbody');tbody.innerHTML='';
      schede.forEach(e=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${e.missione}</td><td>${e.data}</td><td>${e.nome}</td>
        <td><button onclick="editScheda('${e.id}')">Modifica</button>
        <button onclick="deleteScheda('${e.id}')">Elimina</button>
        <button onclick="exportSinglePDF('${e.id}')">PDF</button></td>`;
        tbody.appendChild(tr);
      });
    }
    function resetForm(){document.getElementById('tiForm').reset();editingId=null;}
    document.getElementById('tiForm').addEventListener('submit',function(ev){
      ev.preventDefault();const data=getFormData();
      if(editingId){schede=schede.map(s=>s.id===editingId?data:s);}
      else{schede.push(data);}
      localStorage.setItem('schedeTI',JSON.stringify(schede));
      renderArchivio();resetForm();
    });
    function editScheda(id){const e=schede.find(x=>x.id===id);if(e){setFormData(e);editingId=id;}}
    function deleteScheda(id){if(confirm('Eliminare scheda?')){schede=schede.filter(x=>x.id!==id);localStorage.setItem('schedeTI',JSON.stringify(schede));renderArchivio();}}
    function escapeHtml(text){return text?text.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])):'';}
    function exportSinglePDF(id){
      const e=schede.find(x=>x.id===id);if(!e)return;
      const doc=new jsPDF();let y=10;
      doc.setFontSize(16);doc.text("Scheda TI",105,y,null,null,"center");y+=10;
      const entries=[
        ["Nr Missione",e.missione],["Data",e.data],["Nome paziente",e.nome],
        ["Età",e.eta],["Data di nascita",e.dob],["Corporatura",e.corporatura],
        ["Patologia",e.patologia],["Motivo",e.motivo],["Prelevare da",e.prelevare],
        ["Portare a",e.portare],["Presidio Richiedente",e.pdc],["Telefono PDC",e.tel],
        ["Autista",e.autista],["Soccorritore 1",e.socc1],["Soccorritore 2",e.socc2],
        ["Soccorritore 3",e.socc3],["Tirocinante",e.tiro],
        ["Arrivo in sede",e.arrivoSede],["Arrivo dal paziente",e.arrivoPaz],
        ["Arrivo a destinazione",e.arrivoDest],["Mezzo",e.mezzo],
        ["Prezzo",e.prezzo],["Presidi",e.presidi],["Note",e.note]
      ];
      doc.setFontSize(12);
      entries.forEach(([k,v])=>{doc.text(`${k}: ${v||''}`,10,y);y+=8;if(y>280){doc.addPage();y=10;}});
      if(e.firmaRef){y+=10;doc.text("Firmato da: "+e.firmaRef,10,y);}
      doc.save(`Scheda_${e.missione}.pdf`);
    }
    function exportPDF(){
      if(!schede.length){alert("Nessuna scheda da esportare");return;}
      const doc=new jsPDF();let y=10;
      doc.setFontSize(16);doc.text("Archivio Schede TI",105,y,null,null,"center");y+=10;
      schede.forEach(e=>{
        doc.setFontSize(12);
        doc.text(`Missione ${e.missione} - ${e.data} - ${e.nome}`,10,y);y+=8;
        if(e.firmaRef){doc.text(`Firmato da: ${e.firmaRef}`,10,y);y+=8;}
        y+=4;
        if(y>280){doc.addPage();y=10;}
      });
      doc.save("Archivio_SchedeTI.pdf");
    }
    renderArchivio();
  </script>
</body>
</html>

