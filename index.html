<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Scheda Trasporto - Generatore PDF</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:16px;background:#f6f8fa}
    .container{max-width:1000px;margin:0 auto;background:white;padding:18px;border-radius:8px;box-shadow:0 4px 14px rgba(0,0,0,.06)}
    h1{font-size:20px;margin:0 0 12px}
    form{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    label{font-size:13px}
    input, select, textarea{width:100%;padding:8px;border:1px solid #ddd;border-radius:6px}
    textarea{min-height:60px}
    .full{grid-column:1/3}
    .buttons{display:flex;gap:8px;margin-top:10px}
    table{width:100%;border-collapse:collapse;margin-top:14px}
    th,td{border:1px solid #e2e8f0;padding:8px;font-size:13px;text-align:left}
    th{background:#f1f5f9}
    .small-img{height:40px}
    .actions button{margin-right:6px}
    .sign-box{border:1px dashed #cbd5e1;padding:6px;border-radius:6px}
    .signature-control{display:flex;gap:6px;align-items:center;margin-top:6px}
    .top-row{display:flex;gap:10px}
    @media(max-width:760px){form{grid-template-columns:1fr} .full{grid-column:auto}}
  </style>
</head>
<body>
  <div class="container">
    <h1>Scheda Trasporto — Inserimento dati</h1>

    <form id="mainForm" onsubmit="event.preventDefault();saveEntry();">
      <div><label>Missione N°<input id="missione" required></label></div>
      <div><label>Data<input id="data" type="date" required></label></div>

      <div><label>Nome e cognome<input id="nome"></label></div>
      <div><label>età<input id="eta" type="number" min="0"></label></div>

      <div><label>corporatura<select id="corporatura"><option></option><option>Magro</option><option>Normale</option><option>Robusto</option></select></label></div>
      <div><label>patologia<input id="patologia"></label></div>

      <div><label>motivo trasporto<textarea id="motivo"></textarea></label></div>
      <div><label>prelevare da<input id="prelevare"></label></div>

      <div><label>Piano (prelevare da)<select id="pianoPre"><option></option><option>CA</option><option>SA</option><option>MC</option></select></label></div>
      <div><label>portare a<input id="portare"></label></div>

      <div><label>Piano (portare a)<select id="pianoPort"><option></option><option>CA</option><option>SA</option><option>MC</option></select></label></div>
      <div><label>PDC<input id="pdc"></label></div>

      <div><label>tel<input id="tel" type="tel"></label></div>
      <div><label>email<input id="email" type="email"></label></div>

      <div class="full"><label>autist soccorritore<input id="autista"></label></div>
      <div><label>1° soccorritore<input id="socc1"></label></div>
      <div><label>2° soccorritore<input id="socc2"></label></div>
      <div><label>3° soccorritore<input id="socc3"></label></div>
      <div><label>tirocinante<input id="tiro"></label></div>

      <div><label>arrivo in sede<input id="arrivoSede" type="time"></label></div>
      <div><label>arrivo dal paziente<input id="arrivoPaz" type="time"></label></div>
      <div><label>arrivo a destinazione<input id="arrivoDest" type="time"></label></div>
      <div><label>mezzo assegnato<input id="mezzo"></label></div>

      <div><label>prezzo<input id="prezzo" type="number" step="0.01"></label></div>
      <div><label>presidi necessari<textarea id="presidi"></textarea></label></div>

      <div class="full">
        <label>Note<textarea id="note"></textarea></label>
      </div>

      <div class="full">
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <div style="flex:1">
            <label>Firma operatore (disegna)</label>
            <div class="sign-box">
              <canvas id="sigOp" width="400" height="120"></canvas>
              <div class="signature-control"><button type="button" onclick="clearSig('op')">Pulisci</button><small>Usa dito/mouse per firmare</small></div>
            </div>
          </div>

          <div style="flex:1">
            <label>Firma referente (disegna)</label>
            <div class="sign-box">
              <canvas id="sigRef" width="400" height="120"></canvas>
              <div class="signature-control"><button type="button" onclick="clearSig('ref')">Pulisci</button></div>
            </div>
          </div>

        </div>
      </div>

      <div class="buttons full">
        <button type="submit">Salva scheda</button>
        <button type="button" onclick="resetForm()">Azzera form</button>
        <button type="button" onclick="exportPDF()">Esporta tabella in PDF</button>
        <button type="button" onclick="exportAllAsJSON()">Esporta JSON</button>
      </div>

    </form>

    <div id="pdfArea">
      <h2 style="margin-top:18px">Elenco schede</h2>
      <table id="dataTable">
        <thead>
          <tr>
            <th>Missione N°</th><th>Data</th><th>Nome</th><th>età</th><th>prelevare/portare</th><th>mezzo</th><th>prezzo</th><th>firm.op</th><th>firm.ref</th><th>Azioni</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

  </div>

  <!-- Librerie CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

  <script>
    // SignaturePad init
    const sigOpCanvas = document.getElementById('sigOp');
    const sigRefCanvas = document.getElementById('sigRef');
    const sigOp = new SignaturePad(sigOpCanvas, {backgroundColor:'rgba(255,255,255,0)'});
    const sigRef = new SignaturePad(sigRefCanvas, {backgroundColor:'rgba(255,255,255,0)'});

    function clearSig(who){ if(who==='op') sigOp.clear(); else sigRef.clear(); }

    // Storage
    const STORAGE_KEY = 'schede_trasporto_v1';
    let entries = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    let editingId = null;

    function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,6); }

    function getFormData(){
      return {
        id: editingId || uid(),
        missione: document.getElementById('missione').value,
        data: document.getElementById('data').value,
        nome: document.getElementById('nome').value,
        eta: document.getElementById('eta').value,
        corporatura: document.getElementById('corporatura').value,
        patologia: document.getElementById('patologia').value,
        motivo: document.getElementById('motivo').value,
        prelevare: document.getElementById('prelevare').value,
        pianoPre: document.getElementById('pianoPre').value,
        portare: document.getElementById('portare').value,
        pianoPort: document.getElementById('pianoPort').value,
        pdc: document.getElementById('pdc').value,
        tel: document.getElementById('tel').value,
        email: document.getElementById('email').value,
        autista: document.getElementById('autista').value,
        socc1: document.getElementById('socc1').value,
        socc2: document.getElementById('socc2').value,
        socc3: document.getElementById('socc3').value,
        tiro: document.getElementById('tiro').value,
        arrivoSede: document.getElementById('arrivoSede').value,
        arrivoPaz: document.getElementById('arrivoPaz').value,
        arrivoDest: document.getElementById('arrivoDest').value,
        mezzo: document.getElementById('mezzo').value,
        prezzo: document.getElementById('prezzo').value,
        presidi: document.getElementById('presidi').value,
        note: document.getElementById('note').value,
        firmaOp: sigOp.isEmpty()?null:sigOp.toDataURL(),
        firmaRef: sigRef.isEmpty()?null:sigRef.toDataURL(),
        firmaData: new Date().toISOString()
      };
    }

    function saveEntry(){
      const data = getFormData();
      if(!data.missione){ alert('Compila Missione N°'); return; }
      if(editingId){
        const idx = entries.findIndex(e=>e.id===editingId);
        if(idx!==-1) entries[idx]=data;
        editingId=null;
      } else entries.unshift(data);
      localStorage.setItem(STORAGE_KEY,JSON.stringify(entries));
      renderTable();
      resetForm();
    }

    function renderTable(){
      const tbody = document.querySelector('#dataTable tbody');
      tbody.innerHTML='';
      for(const e of entries){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(e.missione)}</td>
          <td>${escapeHtml(e.data)}</td>
          <td>${escapeHtml(e.nome)}</td>
          <td>${escapeHtml(e.eta)}</td>
          <td>${escapeHtml(e.prelevare)} / ${escapeHtml(e.portare)}<br><small>${escapeHtml(e.pianoPre)} → ${escapeHtml(e.pianoPort)}</small></td>
          <td>${escapeHtml(e.mezzo)}</td>
          <td>${escapeHtml(e.prezzo)}</td>
          <td>${e.firmaOp?'<img class="small-img" src="'+e.firmaOp+'">':''}</td>
          <td>${e.firmaRef?'<img class="small-img" src="'+e.firmaRef+'">':''}</td>
          <td class="actions">
            <button onclick="editEntry('${e.id}')">Modifica</button>
            <button onclick="deleteEntry('${e.id}')">Elimina</button>
            <button onclick="exportSinglePDF('${e.id}')">PDF</button>
          </td>`;
        tbody.appendChild(tr);
      }
    }

    function editEntry(id){
      const e = entries.find(x=>x.id===id);
      if(!e) return;
      editingId = id;
      document.getElementById('missione').value = e.missione;
      document.getElementById('data').value = e.data;
      document.getElementById('nome').value = e.nome;
      document.getElementById('eta').value = e.eta;
      document.getElementById('corporatura').value = e.corporatura;
      document.getElementById('patologia').value = e.patologia;
      document.getElementById('motivo').value = e.motivo;
      document.getElementById('prelevare').value = e.prelevare;
      document.getElementById('pianoPre').value = e.pianoPre;
      document.getElementById('portare').value = e.portare;
      document.getElementById('pianoPort').value = e.pianoPort;
      document.getElementById('pdc').value = e.pdc;
      document.getElementById('tel').value = e.tel;
      document.getElementById('email').value = e.email;
      document.getElementById('autista').value = e.autista;
      document.getElementById('socc1').value = e.socc1;
      document.getElementById('socc2').value = e.socc2;
      document.getElementById('socc3').value = e.socc3;
      document.getElementById('tiro').value = e.tiro;
      document.getElementById('arrivoSede').value = e.arrivoSede;
      document.getElementById('arrivoPaz').value = e.arrivoPaz;
      document.getElementById('arrivoDest').value = e.arrivoDest;
      document.getElementById('mezzo').value = e.mezzo;
      document.getElementById('prezzo').value = e.prezzo;
      document.getElementById('presidi').value = e.presidi;
      document.getElementById('note').value = e.note;
      // restore signatures
      if(e.firmaOp){ sigOp.clear(); sigOp.fromDataURL(e.firmaOp); } else sigOp.clear();
      if(e.firmaRef){ sigRef.clear(); sigRef.fromDataURL(e.firmaRef); } else sigRef.clear();
      window.scrollTo({top:0,behavior:'smooth'});
    }

    function deleteEntry(id){
      if(!confirm('Eliminare questa scheda?')) return;
      entries = entries.filter(x=>x.id!==id);
      localStorage.setItem(STORAGE_KEY,JSON.stringify(entries));
      renderTable();
    }

    function resetForm(){
      editingId=null;
      document.getElementById('mainForm').reset();
      sigOp.clear(); sigRef.clear();
    }

    // Exports
    async function exportPDF(){
      const area = document.getElementById('pdfArea');
      const canvas = await html2canvas(area, {scale:1.5});
      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p','mm','a4');
      const imgProps = pdf.getImageProperties(imgData);
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
      pdf.addImage(imgData,'PNG',0,0,pdfWidth,pdfHeight);
      pdf.save('schede_trasporto.pdf');
    }

    async function exportSinglePDF(id){
      const e = entries.find(x=>x.id===id);
      if(!e) return;
      // composizione HTML temporanea
      const popup = document.createElement('div');
      popup.style.padding='16px'; popup.style.background='white'; popup.style.width='800px';
      popup.innerHTML = `
        <div style="font-family:Arial;">
          <h2>Scheda Missione ${escapeHtml(e.missione)} — ${escapeHtml(e.data)}</h2>
          <table style="width:100%;border-collapse:collapse" border="1">
            <tr><td><b>Nome</b></td><td>${escapeHtml(e.nome)}</td></tr>
            <tr><td><b>età</b></td><td>${escapeHtml(e.eta)}</td></tr>
            <tr><td><b>prelevare/portare</b></td><td>${escapeHtml(e.prelevare)} / ${escapeHtml(e.portare)}</td></tr>
            <tr><td><b>mezzo</b></td><td>${escapeHtml(e.mezzo)}</td></tr>
            <tr><td><b>prezzo</b></td><td>${escapeHtml(e.prezzo)}</td></tr>
            <tr><td><b>Note</b></td><td>${escapeHtml(e.note)}</td></tr>
          </table>
          <div style="margin-top:8px">
            ${e.firmaOp?'<div><b>Firma operatore</b><br><img src="'+e.firmaOp+'" style="max-height:120px"></div>':''}
            ${e.firmaRef?'<div><b>Firma referente</b><br><img src="'+e.firmaRef+'" style="max-height:120px"></div>':''}
          </div>
        </div>
      `;
      document.body.appendChild(popup);
      const canvas = await html2canvas(popup, {scale:1.5});
      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p','mm','a4');
      const imgProps = pdf.getImageProperties(imgData);
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
      pdf.addImage(imgData,'PNG',0,0,pdfWidth,pdfHeight);
      pdf.save('scheda_'+e.missione+'_'+(e.data||'')+'.pdf');
      document.body.removeChild(popup);
    }

    function exportAllAsJSON(){
      const dataStr = JSON.stringify(entries, null, 2);
      const blob = new Blob([dataStr], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href=url; a.download='schede_trasporto.json'; a.click();
      URL.revokeObjectURL(url);
    }

    // Safe helper
    function escapeHtml(str){ if(!str) return ''; return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // init
    renderTable();
  </script>
</body>
</html>
